{"version":3,"file":"tempus.js","sources":["../src/uid.js","../src/index.js"],"sourcesContent":["let index = 0\r\n\r\nexport function getUID() {\r\n  return index++\r\n}\r\n","// Infinity = max FPS (system default)\r\n\r\nimport { getUID } from './uid'\r\n\r\nconst originalRAF = window.requestAnimationFrame\r\nconst originalCancelRAF = window.cancelAnimationFrame\r\n\r\nclass Framerate {\r\n  constructor(fps = Infinity) {\r\n    this.callbacks = []\r\n    this.fps = fps\r\n    this.time = 0\r\n    this.lastTickDate = performance.now()\r\n  }\r\n\r\n  get executionTime() {\r\n    return 1000 / this.fps\r\n  }\r\n\r\n  dispatch(time, deltaTime) {\r\n    for (let i = 0; i < this.callbacks.length; i++) {\r\n      this.callbacks[i].callback(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  raf(time, deltaTime) {\r\n    this.time += deltaTime\r\n\r\n    if (this.fps === Infinity) {\r\n      this.dispatch(time, deltaTime)\r\n    } else if (this.time >= this.executionTime) {\r\n      this.time = this.time % this.executionTime\r\n      const deltaTime = time - this.lastTickDate\r\n      this.lastTickDate = time\r\n\r\n      this.dispatch(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  add({ callback, priority }) {\r\n    if (typeof callback !== 'function') console.error('Tempus.add: callback is not a function')\r\n\r\n    const uid = getUID()\r\n    this.callbacks.push({ callback, priority, uid })\r\n    this.callbacks.sort((a, b) => a.priority - b.priority)\r\n\r\n    return () => this.remove(uid)\r\n  }\r\n\r\n  remove(uid) {\r\n    this.callbacks = this.callbacks.filter(({ uid: u }) => uid !== u)\r\n  }\r\n}\r\n\r\nclass Tempus {\r\n  constructor() {\r\n    /**\r\n     * @private\r\n     */\r\n    this.framerates = {}\r\n\r\n    /**\r\n     * @private\r\n     */\r\n    this.time = performance.now()\r\n    requestAnimationFrame(this.raf)\r\n  }\r\n\r\n  /**\r\n   * @param {Function} callback\r\n   * @param {{ priority?: number, fps?: number }} [options]\r\n   * @returns {Function}\r\n   */\r\n  add(callback, { priority = 0, fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      if (!this.framerates[fps]) this.framerates[fps] = new Framerate(fps)\r\n\r\n      return this.framerates[fps].add({ callback, priority })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  raf = (time) => {\r\n    requestAnimationFrame(this.raf, true)\r\n\r\n    const deltaTime = time - this.time\r\n    this.time = time\r\n\r\n    for (const framerate of Object.values(this.framerates)) {\r\n      framerate.raf(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  patch() {\r\n    window.requestAnimationFrame = (callback, { priority = 0, fps = Infinity } = {}) => {\r\n      if (callback === this.raf || !callback.toString().includes('requestAnimationFrame(')) {\r\n        return originalRAF(callback)\r\n      }\r\n\r\n      if (!callback.__tempusPatched) {\r\n        callback.__tempusPatched = true\r\n        callback.__tempusUnsubscribe = this.add(callback, { priority, fps })\r\n      }\r\n\r\n      return callback.__tempusUnsubscribe\r\n    }\r\n\r\n    window.cancelAnimationFrame = (callback) => {\r\n      if (typeof callback === 'function') callback?.()\r\n\r\n      return originalCancelRAF(callback)\r\n    }\r\n  }\r\n\r\n  unpatch() {\r\n    window.requestAnimationFrame = originalRAF\r\n    window.cancelAnimationFrame = originalCancelRAF\r\n  }\r\n}\r\n\r\nconst isClient = typeof window !== 'undefined'\r\n\r\nexport default isClient && new Tempus()\r\n"],"names":["index","originalRAF","window","requestAnimationFrame","originalCancelRAF","cancelAnimationFrame","Framerate","fps","Infinity","this","callbacks","time","lastTickDate","performance","now","_proto","prototype","dispatch","deltaTime","i","length","callback","raf","executionTime","add","_ref","_this","priority","console","error","uid","push","sort","a","b","remove","filter","_ref2","key","get","Tempus","_this2","_i","_Object$values","Object","values","framerates","_proto2","_temp","_ref3","_ref3$priority","_ref3$fps","patch","_this3","_temp2","_ref4","_ref4$priority","_ref4$fps","toString","includes","__tempusPatched","__tempusUnsubscribe","unpatch","isClient"],"mappings":"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"}