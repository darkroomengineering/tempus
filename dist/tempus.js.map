{"version":3,"file":"tempus.js","sources":["../src/uid.js","../src/index.js"],"sourcesContent":["let index = 0\r\n\r\nexport function getUID() {\r\n  return index++\r\n}\r\n","// Infinity = max FPS (system default)\r\n\r\nimport { getUID } from './uid'\r\n\r\nclass Framerate {\r\n  constructor(fps = Infinity) {\r\n    this.callbacks = []\r\n    this.fps = fps\r\n    this.time = 0\r\n    this.lastTickDate = performance.now()\r\n  }\r\n\r\n  get executionTime() {\r\n    return 1000 / this.fps\r\n  }\r\n\r\n  dispatch(time, deltaTime) {\r\n    for (let i = 0; i < this.callbacks.length; i++) {\r\n      this.callbacks[i].callback(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  raf(time, deltaTime) {\r\n    this.time += deltaTime\r\n\r\n    if (this.fps === Infinity) {\r\n      this.dispatch(time, deltaTime)\r\n    } else if (this.time >= this.executionTime) {\r\n      this.time = this.time % this.executionTime\r\n      const deltaTime = time - this.lastTickDate\r\n      this.lastTickDate = time\r\n\r\n      this.dispatch(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  add({ callback, priority }) {\r\n    const uid = getUID()\r\n    this.callbacks.push({ callback, priority, uid })\r\n    this.callbacks.sort((a, b) => a.priority - b.priority)\r\n\r\n    return () => this.remove(uid)\r\n  }\r\n\r\n  remove(uid) {\r\n    this.callbacks = this.callbacks.filter(({ uid: u }) => uid !== u)\r\n  }\r\n}\r\n\r\nclass Tempus {\r\n  constructor() {\r\n    /**\r\n     * @private\r\n     */\r\n    this.framerates = {}\r\n\r\n    /**\r\n     * @private\r\n     */\r\n    this.time = performance.now()\r\n    requestAnimationFrame(this.raf)\r\n  }\r\n\r\n  /**\r\n   * @param {Function} callback\r\n   * @param {{ priority?: number, fps?: number }} [options]\r\n   * @returns {Function}\r\n   */\r\n  add(callback, { priority = 0, fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      if (!this.framerates[fps]) this.framerates[fps] = new Framerate(fps)\r\n\r\n      return this.framerates[fps].add({ callback, priority })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  raf = (time) => {\r\n    requestAnimationFrame(this.raf, true)\r\n\r\n    const deltaTime = time - this.time\r\n    this.time = time\r\n\r\n    for (const framerate of Object.values(this.framerates)) {\r\n      framerate.raf(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  patch() {\r\n    const originalRAF = window.requestAnimationFrame\r\n    const originalCancelRAF = window.cancelAnimationFrame\r\n\r\n    window.requestAnimationFrame = (callback, { priority = 0, fps = Infinity } = {}) => {\r\n      if (callback === this.raf || !callback.toString().includes('requestAnimationFrame(')) {\r\n        return originalRAF(callback)\r\n      }\r\n\r\n      if (!callback.__tempusPatched) {\r\n        callback.__tempusPatched = true\r\n        callback.__tempusUnsubscribe = this.add(callback, { priority, fps })\r\n      }\r\n\r\n      return callback.__tempusUnsubscribe\r\n    }\r\n\r\n    window.cancelAnimationFrame = (callback) => {\r\n      if (typeof callback === 'function') callback?.()\r\n\r\n      return originalCancelRAF(callback)\r\n    }\r\n  }\r\n}\r\n\r\nconst isClient = typeof window !== 'undefined'\r\n\r\nexport default isClient && new Tempus()\r\n"],"names":["index","Framerate","fps","Infinity","this","callbacks","time","lastTickDate","performance","now","_proto","prototype","dispatch","deltaTime","i","length","callback","raf","executionTime","add","_ref","_this","uid","push","priority","sort","a","b","remove","filter","_ref2","key","get","Tempus","_this2","requestAnimationFrame","_i","_Object$values","Object","values","framerates","_proto2","_temp","_ref3","_ref3$priority","_ref3$fps","patch","_this3","originalRAF","window","originalCancelRAF","cancelAnimationFrame","_temp2","_ref4","_ref4$priority","_ref4$fps","toString","includes","__tempusPatched","__tempusUnsubscribe","isClient"],"mappings":"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"}