{"version":3,"file":"tempus.js","sources":["../src/uid.js","../src/index.js"],"sourcesContent":["let index = 0\r\n\r\nexport function getUID() {\r\n  return index++\r\n}\r\n","// Infinity = max FPS (system default)\r\n\r\nimport { getUID } from './uid'\r\n\r\nclass Framerate {\r\n  constructor(fps = Infinity) {\r\n    this.callbacks = []\r\n    this.fps = fps\r\n    this.now = performance.now()\r\n    this.lastTickDate = performance.now()\r\n  }\r\n\r\n  get executionTime() {\r\n    return 1000 / this.fps\r\n  }\r\n\r\n  dispatch(now, deltaTime) {\r\n    for (let i = 0; i < this.callbacks.length; i++) {\r\n      this.callbacks[i].callback(now, deltaTime)\r\n    }\r\n  }\r\n\r\n  raf(now, deltaTime) {\r\n    this.now += deltaTime\r\n\r\n    if (this.fps === Infinity) {\r\n      this.dispatch(now, deltaTime)\r\n    } else if (this.now >= this.executionTime) {\r\n      this.now = this.now % this.executionTime\r\n      const deltaTime = now - this.lastTickDate\r\n      this.lastTickDate = now\r\n\r\n      this.dispatch(now, deltaTime)\r\n    }\r\n  }\r\n\r\n  add({ callback, priority }) {\r\n    const uid = getUID()\r\n    this.callbacks.push({ callback, priority, uid })\r\n    this.callbacks.sort((a, b) => a.priority - b.priority)\r\n\r\n    return () => this.remove(uid)\r\n  }\r\n\r\n  remove(uid) {\r\n    this.callbacks = this.callbacks.filter(({ uid: u }) => uid !== u)\r\n  }\r\n}\r\n\r\nclass Tempus {\r\n  constructor() {\r\n    this.framerates = {}\r\n    this.now = performance.now()\r\n    requestAnimationFrame(this.raf)\r\n  }\r\n\r\n  add(callback, { priority = 0, fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      if (!this.framerates[fps]) this.framerates[fps] = new Framerate(fps)\r\n\r\n      return this.framerates[fps].add({ callback, priority })\r\n    }\r\n  }\r\n\r\n  remove(uid, { fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      this.framerates[fps].remove(uid)\r\n    }\r\n  }\r\n\r\n  raf = (now) => {\r\n    requestAnimationFrame(this.raf, true)\r\n\r\n    const deltaTime = now - this.now\r\n    this.now = now\r\n\r\n    for (const framerate of Object.values(this.framerates)) {\r\n      framerate.raf(now, deltaTime)\r\n    }\r\n  }\r\n\r\n  patch() {\r\n    console.log('Tempus is taking over the rAf')\r\n    const originalRAF = window.requestAnimationFrame\r\n    const originalCancelRAF = window.cancelAnimationFrame\r\n\r\n    window.requestAnimationFrame = (callback, { priority = 0, fps = Infinity } = {}) => {\r\n      if (callback === this.raf) {\r\n        return originalRAF(callback)\r\n      }\r\n\r\n      if (!callback.patched) {\r\n        const remove = this.add(callback, { priority, fps })\r\n        callback.patched = true\r\n        callback.remove = remove\r\n      }\r\n\r\n      return callback.remove\r\n    }\r\n\r\n    window.cancelAnimationFrame = (callback) => {\r\n      if (typeof callback === 'function') callback?.()\r\n\r\n      return originalCancelRAF(callback)\r\n    }\r\n  }\r\n}\r\n\r\nconst isClient = typeof window !== 'undefined'\r\n\r\nexport default isClient && new Tempus()\r\n"],"names":["index","Framerate","fps","Infinity","this","callbacks","now","performance","lastTickDate","_proto","prototype","dispatch","deltaTime","i","length","callback","raf","executionTime","add","_ref","_this","uid","push","priority","sort","a","b","remove","filter","_ref2","key","get","Tempus","_this2","requestAnimationFrame","_i","_Object$values","Object","values","framerates","_proto2","_temp","_ref3","_ref3$priority","_ref3$fps","_temp2","_ref4$fps","patch","_this3","console","log","originalRAF","window","originalCancelRAF","cancelAnimationFrame","_temp3","_ref5","_ref5$priority","_ref5$fps","patched","isClient"],"mappings":"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"}