{"version":3,"file":"tempus.modern.mjs","sources":["../src/uid.js","../src/index.js"],"sourcesContent":["let index = 0\r\n\r\nexport function getUID() {\r\n  return index++\r\n}\r\n","// Infinity = max FPS (system default)\r\n\r\nimport { getUID } from './uid'\r\n\r\nconst originalRAF = window.requestAnimationFrame\r\nconst originalCancelRAF = window.cancelAnimationFrame\r\n\r\nclass Framerate {\r\n  constructor(fps = Infinity) {\r\n    this.callbacks = []\r\n    this.fps = fps\r\n    this.time = 0\r\n    this.lastTickDate = performance.now()\r\n  }\r\n\r\n  get executionTime() {\r\n    return 1000 / this.fps\r\n  }\r\n\r\n  dispatch(time, deltaTime) {\r\n    for (let i = 0; i < this.callbacks.length; i++) {\r\n      this.callbacks[i].callback(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  raf(time, deltaTime) {\r\n    this.time += deltaTime\r\n\r\n    if (this.fps === Infinity) {\r\n      this.dispatch(time, deltaTime)\r\n    } else if (this.time >= this.executionTime) {\r\n      this.time = this.time % this.executionTime\r\n      const deltaTime = time - this.lastTickDate\r\n      this.lastTickDate = time\r\n\r\n      this.dispatch(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  add({ callback, priority }) {\r\n    if (typeof callback !== 'function') console.error('Tempus.add: callback is not a function')\r\n\r\n    const uid = getUID()\r\n    this.callbacks.push({ callback, priority, uid })\r\n    this.callbacks.sort((a, b) => a.priority - b.priority)\r\n\r\n    return () => this.remove(uid)\r\n  }\r\n\r\n  remove(uid) {\r\n    this.callbacks = this.callbacks.filter(({ uid: u }) => uid !== u)\r\n  }\r\n}\r\n\r\nclass Tempus {\r\n  constructor() {\r\n    /**\r\n     * @private\r\n     */\r\n    this.framerates = {}\r\n\r\n    /**\r\n     * @private\r\n     */\r\n    this.time = performance.now()\r\n    requestAnimationFrame(this.raf)\r\n  }\r\n\r\n  /**\r\n   * @param {Function} callback\r\n   * @param {{ priority?: number, fps?: number }} [options]\r\n   * @returns {Function}\r\n   */\r\n  add(callback, { priority = 0, fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      if (!this.framerates[fps]) this.framerates[fps] = new Framerate(fps)\r\n\r\n      return this.framerates[fps].add({ callback, priority })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  raf = (time) => {\r\n    requestAnimationFrame(this.raf, true)\r\n\r\n    const deltaTime = time - this.time\r\n    this.time = time\r\n\r\n    for (const framerate of Object.values(this.framerates)) {\r\n      framerate.raf(time, deltaTime)\r\n    }\r\n  }\r\n\r\n  patch() {\r\n    window.requestAnimationFrame = (callback, { priority = 0, fps = Infinity } = {}) => {\r\n      if (callback === this.raf || !callback.toString().includes('requestAnimationFrame(')) {\r\n        return originalRAF(callback)\r\n      }\r\n\r\n      if (!callback.__tempusPatched) {\r\n        callback.__tempusPatched = true\r\n        callback.__tempusUnsubscribe = this.add(callback, { priority, fps })\r\n      }\r\n\r\n      return callback.__tempusUnsubscribe\r\n    }\r\n\r\n    window.cancelAnimationFrame = (callback) => {\r\n      if (typeof callback === 'function') {\r\n        callback?.()\r\n        return\r\n      }\r\n\r\n      return originalCancelRAF(callback)\r\n    }\r\n  }\r\n\r\n  unpatch() {\r\n    window.requestAnimationFrame = originalRAF\r\n    window.cancelAnimationFrame = originalCancelRAF\r\n  }\r\n}\r\n\r\nconst isClient = typeof window !== 'undefined'\r\n\r\nexport default isClient && new Tempus()\r\n"],"names":["index","originalRAF","window","requestAnimationFrame","originalCancelRAF","cancelAnimationFrame","Framerate","constructor","fps","Infinity","this","callbacks","time","lastTickDate","performance","now","executionTime","dispatch","deltaTime","i","length","callback","raf","add","priority","console","error","uid","push","sort","a","b","remove","filter","u","framerate","Object","values","framerates","patch","toString","includes","__tempusPatched","__tempusUnsubscribe","unpatch"],"mappings":"AAAA,IAAIA,EAAQ,ECIZ,MAAMC,EAAcC,OAAOC,sBACrBC,EAAoBF,OAAOG,qBAEjC,MAAMC,EACJC,YAAYC,EAAMC,UAChBC,KAAKC,UAAY,GACjBD,KAAKF,IAAMA,EACXE,KAAKE,KAAO,EACZF,KAAKG,aAAeC,YAAYC,KAClC,CAEIC,oBACF,OAAO,IAAON,KAAKF,GACrB,CAEAS,SAASL,EAAMM,GACb,IAAK,IAAIC,EAAI,EAAGA,EAAIT,KAAKC,UAAUS,OAAQD,IACzCT,KAAKC,UAAUQ,GAAGE,SAAST,EAAMM,EAErC,CAEAI,IAAIV,EAAMM,GAGR,GAFAR,KAAKE,MAAQM,EAEIT,WAAbC,KAAKF,IACPE,KAAKO,SAASL,EAAMM,QACX,GAAAR,KAAKE,MAAQF,KAAKM,cAAe,CAC1CN,KAAKE,KAAOF,KAAKE,KAAOF,KAAKM,cAC7B,MAAME,EAAYN,EAAOF,KAAKG,aAC9BH,KAAKG,aAAeD,EAEpBF,KAAKO,SAASL,EAAMM,EACtB,CACF,CAEAK,KAAIF,SAAEA,EAAQG,SAAEA,IACU,mBAAbH,GAAyBI,QAAQC,MAAM,0CAElD,MAAMC,EDvCD3B,IC2CL,OAHAU,KAAKC,UAAUiB,KAAK,CAAEP,WAAUG,WAAUG,QAC1CjB,KAAKC,UAAUkB,KAAK,CAACC,EAAGC,IAAMD,EAAEN,SAAWO,EAAEP,UAEtC,IAAMd,KAAKsB,OAAOL,EAC3B,CAEAK,OAAOL,GACLjB,KAAKC,UAAYD,KAAKC,UAAUsB,OAAO,EAAGN,IAAKO,KAAQP,IAAQO,EACjE,EA4EF,IAAAlC,EAFmC,oBAAXE,QAEG,IAzE3B,MACEK,mBA6BAe,IAAOV,IACLT,sBAAsBO,KAAKY,KAAK,GAEhC,MAAMJ,EAAYN,EAAOF,KAAKE,KAC9BF,KAAKE,KAAOA,EAEZ,IAAK,MAAMuB,KAAaC,OAAOC,OAAO3B,KAAK4B,YACzCH,EAAUb,IAAIV,EAAMM,EACtB,EAjCAR,KAAK4B,WAAa,CAAA,EAKlB5B,KAAKE,KAAOE,YAAYC,MACxBZ,sBAAsBO,KAAKY,IAC7B,CAOAC,IAAIF,GAAUG,SAAEA,EAAW,EAAChB,IAAEA,EAAMC,UAAa,CAAA,GAC/C,GAAmB,iBAARD,EAGT,OAFKE,KAAK4B,WAAW9B,KAAME,KAAK4B,WAAW9B,GAAO,IAAIF,EAAUE,IAErDE,KAAC4B,WAAW9B,GAAKe,IAAI,CAAEF,WAAUG,YAEhD,CAgBAe,QACErC,OAAOC,sBAAwB,CAACkB,GAAYG,SAAAA,EAAW,EAAGhB,IAAAA,EAAMC,UAAa,KACvEY,IAAaX,KAAKY,KAAQD,EAASmB,WAAWC,SAAS,2BAItDpB,EAASqB,kBACZrB,EAASqB,iBAAkB,EAC3BrB,EAASsB,oBAAsBjC,KAAKa,IAAIF,EAAU,CAAEG,SAAAA,EAAUhB,IAAAA,KAGzDa,EAASsB,qBARP1C,EAAYoB,GAWvBnB,OAAOG,qBAAwBgB,IAC7B,GAAwB,mBAAbA,EAKX,OAAOjB,EAAkBiB,GAJvBA,MAAAA,GAAAA,GAI+B,CAErC,CAEAuB,UACE1C,OAAOC,sBAAwBF,EAC/BC,OAAOG,qBAAuBD,CAChC"}