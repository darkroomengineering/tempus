{"version":3,"file":"tempus.modern.mjs","sources":["../src/uid.js","../src/index.js"],"sourcesContent":["let index = 0\r\n\r\nexport function getUID() {\r\n  return index++\r\n}\r\n","// Infinity = max FPS (system default)\r\n\r\nimport { getUID } from './uid'\r\n\r\nclass Framerate {\r\n  constructor(fps = Infinity) {\r\n    this.callbacks = []\r\n    this.fps = fps\r\n    this.now = performance.now()\r\n    this.lastTickDate = performance.now()\r\n  }\r\n\r\n  get executionTime() {\r\n    return 1000 / this.fps\r\n  }\r\n\r\n  dispatch(now, deltaTime) {\r\n    for (let i = 0; i < this.callbacks.length; i++) {\r\n      this.callbacks[i].callback(now, deltaTime)\r\n    }\r\n  }\r\n\r\n  raf(now, deltaTime) {\r\n    this.now += deltaTime\r\n\r\n    if (this.fps === Infinity) {\r\n      this.dispatch(now, deltaTime)\r\n    } else if (this.now >= this.executionTime) {\r\n      this.now = this.now % this.executionTime\r\n      const deltaTime = now - this.lastTickDate\r\n      this.lastTickDate = now\r\n\r\n      this.dispatch(now, deltaTime)\r\n    }\r\n  }\r\n\r\n  add({ callback, priority }) {\r\n    const uid = getUID()\r\n    this.callbacks.push({ callback, priority, uid })\r\n    this.callbacks.sort((a, b) => a.priority - b.priority)\r\n\r\n    return () => this.remove(uid)\r\n  }\r\n\r\n  remove(uid) {\r\n    this.callbacks = this.callbacks.filter(({ uid: u }) => uid !== u)\r\n  }\r\n}\r\n\r\nclass Tempus {\r\n  constructor() {\r\n    this.framerates = {}\r\n    this.now = performance.now()\r\n    requestAnimationFrame(this.raf)\r\n  }\r\n\r\n  add(callback, { priority = 0, fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      if (!this.framerates[fps]) this.framerates[fps] = new Framerate(fps)\r\n\r\n      return this.framerates[fps].add({ callback, priority })\r\n    }\r\n  }\r\n\r\n  remove(uid, { fps = Infinity } = {}) {\r\n    if (typeof fps === 'number') {\r\n      this.framerates[fps].remove(uid)\r\n    }\r\n  }\r\n\r\n  raf = (now) => {\r\n    requestAnimationFrame(this.raf, true)\r\n\r\n    const deltaTime = now - this.now\r\n    this.now = now\r\n\r\n    for (const framerate of Object.values(this.framerates)) {\r\n      framerate.raf(now, deltaTime)\r\n    }\r\n  }\r\n\r\n  patch() {\r\n    console.log('Tempus is taking over the rAf')\r\n    const originalRAF = window.requestAnimationFrame\r\n    const originalCancelRAF = window.cancelAnimationFrame\r\n\r\n    window.requestAnimationFrame = (callback, { priority = 0, fps = Infinity } = {}) => {\r\n      if (callback === this.raf) {\r\n        return originalRAF(callback)\r\n      }\r\n\r\n      if (!callback.patched) {\r\n        const remove = this.add(callback, { priority, fps })\r\n        callback.patched = true\r\n        callback.remove = remove\r\n      }\r\n\r\n      return callback.remove\r\n    }\r\n\r\n    window.cancelAnimationFrame = (callback) => {\r\n      if (typeof callback === 'function') callback?.()\r\n\r\n      return originalCancelRAF(callback)\r\n    }\r\n  }\r\n}\r\n\r\nconst isClient = typeof window !== 'undefined'\r\n\r\nexport default isClient && new Tempus()\r\n"],"names":["index","Framerate","constructor","fps","Infinity","this","callbacks","now","performance","lastTickDate","executionTime","dispatch","deltaTime","i","length","callback","raf","add","priority","uid","push","sort","a","b","remove","filter","u","window","requestAnimationFrame","framerate","Object","values","framerates","patch","console","log","originalRAF","originalCancelRAF","cancelAnimationFrame","patched"],"mappings":"AAAA,IAAIA,EAAQ,ECIZ,MAAMC,EACJC,YAAYC,EAAMC,UAChBC,KAAKC,UAAY,GACjBD,KAAKF,IAAMA,EACXE,KAAKE,IAAMC,YAAYD,MACvBF,KAAKI,aAAeD,YAAYD,KAClC,CAEIG,oBACF,WAAcL,KAAKF,GACrB,CAEAQ,SAASJ,EAAKK,GACZ,IAAK,IAAIC,EAAI,EAAGA,EAAIR,KAAKC,UAAUQ,OAAQD,IACzCR,KAAKC,UAAUO,GAAGE,SAASR,EAAKK,EAEpC,CAEAI,IAAIT,EAAKK,GAGP,GAFAP,KAAKE,KAAOK,EAEKR,WAAbC,KAAKF,IACPE,KAAKM,SAASJ,EAAKK,QACV,GAAAP,KAAKE,KAAOF,KAAKK,cAAe,CACzCL,KAAKE,IAAMF,KAAKE,IAAMF,KAAKK,cAC3B,MAAME,EAAYL,EAAMF,KAAKI,aAC7BJ,KAAKI,aAAeF,EAEpBF,KAAKM,SAASJ,EAAKK,EACrB,CACF,CAEAK,KAAIF,SAAEA,EAAQG,SAAEA,IACd,MAAMC,EDlCDnB,ICsCL,OAHAK,KAAKC,UAAUc,KAAK,CAAEL,WAAUG,WAAUC,QAC1Cd,KAAKC,UAAUe,KAAK,CAACC,EAAGC,IAAMD,EAAEJ,SAAWK,EAAEL,UAEtC,IAAMb,KAAKmB,OAAOL,EAC3B,CAEAK,OAAOL,GACLd,KAAKC,UAAYD,KAAKC,UAAUmB,OAAO,EAAGN,IAAKO,KAAQP,IAAQO,EACjE,EAgEF,IAAA1B,EAFmC,oBAAX2B,QAEG,IA7D3B,MACEzB,cAAcG,KAoBdW,IAAOT,IACLqB,sBAAsBvB,KAAKW,KAAK,GAEhC,MAAMJ,EAAYL,EAAMF,KAAKE,IAC7BF,KAAKE,IAAMA,EAEX,IAAK,MAAMsB,KAAaC,OAAOC,OAAO1B,KAAK2B,YACzCH,EAAUb,IAAIT,EAAKK,EACrB,EA3BAP,KAAK2B,WAAa,CAAA,EAClB3B,KAAKE,IAAMC,YAAYD,MACvBqB,sBAAsBvB,KAAKW,IAC7B,CAEAC,IAAIF,GAAUG,SAAEA,EAAW,EAACf,IAAEA,EAAMC,UAAa,IAC/C,GAAmB,iBAARD,EAGT,OAFKE,KAAK2B,WAAW7B,KAAME,KAAK2B,WAAW7B,GAAO,IAAIF,EAAUE,IAEzDE,KAAK2B,WAAW7B,GAAKc,IAAI,CAAEF,WAAUG,YAEhD,CAEAM,OAAOL,GAAKhB,IAAEA,EAAMC,UAAa,CAAA,GACZ,iBAARD,GACTE,KAAK2B,WAAW7B,GAAKqB,OAAOL,EAEhC,CAaAc,QACEC,QAAQC,IAAI,iCACZ,MAAMC,EAAcT,OAAOC,sBACrBS,EAAoBV,OAAOW,qBAEjCX,OAAOC,sBAAwB,CAACb,GAAYG,SAAAA,EAAW,EAAGf,IAAAA,EAAMC,UAAa,CAAE,KAC7E,GAAIW,IAAaV,KAAKW,IACpB,OAAOoB,EAAYrB,GAGrB,IAAKA,EAASwB,QAAS,CACrB,MAAMf,EAASnB,KAAKY,IAAIF,EAAU,CAAEG,SAAAA,EAAUf,IAAAA,IAC9CY,EAASwB,SAAU,EACnBxB,EAASS,OAASA,CACpB,CAEA,OAAOT,EAASS,QAGlBG,OAAOW,qBAAwBvB,IACL,mBAAbA,IAAiC,MAARA,GAAAA,KAE7BsB,EAAkBtB,GAE7B"}